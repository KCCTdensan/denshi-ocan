const sleep=t=>new Promise(e=>setTimeout(e,t)),q=t=>document.querySelector(t),target=q("#target"),entity=[q("#dencon")],entityAnime=[q("#denconAnime")],animationRotL="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true";animationLookback="property: rotation; to: 0 0 0; dur: 1000; easing: easeInOutQuad",animationCenter="property: position; to: 0 0 0; dur: 1000; easing: easeInOutQuad";let slot=0,fuwafuwaLast=!0,_fuwafuwa=!0,animeLast=animationRotL,dancing=0;function slotting(t){pauseAnime(),slot=t,resumeAnime()}function pauseFuwafuwa(){_fuwafuwa=!1}function resumeFuwafuwa(){fuwafuwaLast&&startFuwafuwa()}function startFuwafuwa(){fuwafuwaLast=_fuwafuwa=!0,t();function t(e){!_fuwafuwa||(entity[slot].setAttribute("position",`0 ${(Math.sin(e/200)+1)/4} 0`),requestAnimationFrame(t))}}function pauseAnime(t=!1){if(!t&&dancing){stopDance();return}pauseFuwafuwa(),entity[slot].removeAttribute("animation")}function resumeAnime(){resumeFuwafuwa(),entity[slot].setAttribute("animation",animeLast)}function startRotL(){animeLast=animationRotL,entity[slot].setAttribute("animation",animationRotL)}const lookback=()=>new Promise(t=>{pauseAnime(!0),entity[slot].setAttribute("animation__rot",animationLookback),entity[slot].setAttribute("animation__ctr",animationCenter),entity[slot].addEventListener("animationcomplete",e);function e(){entity[slot].removeEventListener("animationcomplete",e),entity[slot].removeAttribute("animation__rot"),entity[slot].removeAttribute("animation__ctr"),t()}});function stopDance(){switch(dancing){case 0:break;case 1:dancing=0;break;case 2:dancing=0,entityAnime[slot].removeEventListener("animation-finished",onDanceEnd),entityAnime[slot].setAttribute("visible","false"),entityAnime[slot].removeAttribute("animation-mixer"),entity[slot].setAttribute("visible","true");break;case 3:dancing=0;break}}entity.forEach((t,e)=>t.addEventListener("click",async()=>{if(!dancing){if(dancing=1,await lookback(),await sleep(250),!dancing)return;dancing=2,entity[e].setAttribute("visible","false"),entity[e].setAttribute("position","0 0 0"),entityAnime[e].setAttribute("visible","true"),entityAnime[e].setAttribute("animation-mixer","loop: once"),entityAnime[e].addEventListener("animation-finished",onDanceEnd)}}));async function onDanceEnd(){!dancing||(dancing=3,entityAnime[slot].removeEventListener("animation-finished",onDanceEnd),entityAnime[slot].setAttribute("visible","false"),entityAnime[slot].removeAttribute("animation-mixer"),entity[slot].setAttribute("visible","true"),await sleep(500),dancing&&(dancing=0,resumeAnime()))}target.addEventListener("targetFound",resumeAnime),target.addEventListener("targetLost",pauseAnime),window.handler=t=>{},startFuwafuwa(),startRotL();
