const sleep=t=>new Promise(e=>setTimeout(e,t)),q=t=>document.querySelector(t),target=q("#target"),entity=[q("#dencon"),q("#denconRed")],entityUra=[q("#denconRed"),q("#dencon")],entityAnime=[q("#denconAnime"),q("#denconAnime2")],animationRotL="property: rotation; to: 0 360 0; dur: 4000; easing: linear; loop: true",animationLookback="property: rotation; to: 0 0 0; dur: 1000; easing: easeInOutQuad",animationCenter="property: position; to: 0 0 0; dur: 1000; easing: easeInOutQuad",animationSwitchToR="property: position; to: 5 0 0; dur: 1000; easing: easeOutQuad",animationSwitchToL="property: position; to: -5 0 0; dur: 1000; easing: easeOutQuad",animationSwitchFromR="property: position; to: 0 0 0; dur: 1000; easing: easeOutQuad",animationSwitchFromL="property: position; to: 0 0 0; dur: 1000; easing: easeOutQuad";let slot=0,switching=!1,fuwafuwaLast=!0,_fuwafuwa=!0,animeLast=animationRotL,dancing=0;const playAnime=(t,e)=>new Promise(n=>{entity[t].setAttribute("animation",e),entity[t].addEventListener("animationcomplete",i);function i(){entity[t].removeEventListener("animationcomplete",i),n()}});async function slotting(t){switching||t==slot||t<0||t>=entity.length||(pauseAnime(),switching=!0,t<slot?(entity[t].setAttribute("position","-5 0 0"),entity[t].setAttribute("visible","true"),entity[slot].setAttribute("visible","true"),await Promise.all([playAnime(t,animationSwitchFromL),playAnime(slot,animationSwitchToR)]),entity[slot].setAttribute("visible","false"),entity[slot].removeAttribute("animation"),entity[t].setAttribute("position","0 0 0")):(entity[t].setAttribute("position","5 0 0"),entity[t].setAttribute("visible","true"),entity[slot].setAttribute("visible","true"),await Promise.all([playAnime(t,animationSwitchFromR),playAnime(slot,animationSwitchToL)]),entity[slot].setAttribute("visible","false"),entity[slot].removeAttribute("animation"),entity[t].setAttribute("position","0 0 0")),await sleep(100),slot=t,switching=!1,resumeAnime())}function pauseFuwafuwa(){_fuwafuwa=!1}function resumeFuwafuwa(){fuwafuwaLast&&startFuwafuwa()}function startFuwafuwa(){fuwafuwaLast=_fuwafuwa=!0,t();function t(e){!_fuwafuwa||(entity[slot].setAttribute("position",`0 ${(Math.sin(e/200)+1)/4} 0`),requestAnimationFrame(t))}}function pauseAnime(t=!1){if(!switching){if(!t&&dancing){stopDance();return}pauseFuwafuwa(),entity[slot].removeAttribute("animation")}}function resumeAnime(){resumeFuwafuwa(),entity[slot].setAttribute("animation",animeLast)}function startRotL(){animeLast=animationRotL,entity[slot].setAttribute("animation",animationRotL)}const lookback=()=>new Promise(t=>{pauseAnime(!0),entity[slot].setAttribute("animation__rot",animationLookback),entity[slot].setAttribute("animation__ctr",animationCenter),entity[slot].addEventListener("animationcomplete",e);function e(){entity[slot].removeEventListener("animationcomplete",e),entity[slot].removeAttribute("animation__rot"),entity[slot].removeAttribute("animation__ctr"),t()}});function stopDance(){switch(dancing){case 0:break;case 1:dancing=0;break;case 2:dancing=0,entityAnime[slot].removeEventListener("animation-finished",onDanceEnd),entityAnime[slot].setAttribute("visible","false"),entityAnime[slot].removeAttribute("animation-mixer"),entity[slot].setAttribute("visible","true");break;case 3:dancing=0;break}}entity.forEach((t,e)=>t.addEventListener("click",async()=>{if(!dancing){if(dancing=1,await lookback(),await sleep(250),!dancing)return;dancing=2,entity[e].setAttribute("visible","false"),entity[e].setAttribute("position","0 0 0"),entityAnime[e].setAttribute("visible","true"),entityAnime[e].setAttribute("animation-mixer","loop: once"),entityAnime[e].addEventListener("animation-finished",onDanceEnd)}}));async function onDanceEnd(){!dancing||(dancing=3,entityAnime[slot].removeEventListener("animation-finished",onDanceEnd),entityAnime[slot].setAttribute("visible","false"),entityAnime[slot].removeAttribute("animation-mixer"),entity[slot].setAttribute("visible","true"),await sleep(500),dancing&&(dancing=0,resumeAnime()))}target.addEventListener("targetFound",resumeAnime),target.addEventListener("targetLost",pauseAnime),window.handler=t=>{},sleep(1e4).then(()=>slotting(1)),sleep(2e4).then(()=>slotting(0)),startFuwafuwa(),startRotL();
